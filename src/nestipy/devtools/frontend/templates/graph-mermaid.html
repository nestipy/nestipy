<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nestipy Devtools - Dependency Graph</title>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: #e2e8f0;
      }
      h1 {
        font-size: 20px;
        margin: 0;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #1f2937;
        background: #0b1220;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .toolbar button {
        background: #111827;
        border: 1px solid #1f2937;
        color: #e2e8f0;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .toolbar select {
        background: #0f172a;
        border: 1px solid #1f2937;
        color: #e2e8f0;
        padding: 8px 10px;
        border-radius: 8px;
      }
      .toolbar button:hover {
        border-color: #334155;
      }
      .card {
        background: #111827;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 16px;
        margin: 16px 20px;
        overflow: auto;
      }
      .card.full {
        height: calc(100vh - 180px);
      }
      .mermaid {
        min-height: 200px;
      }
      .footer {
        padding: 10px 20px;
        font-size: 12px;
        color: #94a3b8;
        border-top: 1px solid #1f2937;
        background: #0b1220;
      }
      .status {
        font-size: 12px;
        color: #cbd5f5;
        margin-left: 12px;
      }
      a {
        color: #38bdf8;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Nestipy Dependency Graph (Mermaid)</h1>
      <div class="toolbar">
        <select id="mode">
          <option value="modules">Modules</option>
          <option value="dependencies">Dependencies</option>
        </select>
        <button id="switchRenderer">Cytoscape View</button>
        <span id="status" class="status"></span>
      </div>
    </div>
    <div class="card full">
      <div class="mermaid" id="graph">Loading...</div>
    </div>
    <div class="footer">
      Data: <a href="__NESTIPY_GRAPH_JSON__">graph.json</a>
    </div>
    <script>
      (function () {
        const graphUrl = "__NESTIPY_GRAPH_JSON__";
        const localMermaidUrl = "__NESTIPY_STATIC_ROOT__/vendor/mermaid.min.js";
        const statusEl = document.getElementById("status");
        const graphEl = document.getElementById("graph");
        const modeEl = document.getElementById("mode");
        const switchBtn = document.getElementById("switchRenderer");
        const params = new URLSearchParams(window.location.search);

        function currentMode() {
          return params.get("mode") || "modules";
        }

        modeEl.value = currentMode();
        modeEl.addEventListener("change", () => {
          params.set("mode", modeEl.value);
          window.location.search = params.toString();
        });

        switchBtn.addEventListener("click", () => {
          params.set("renderer", "cytoscape");
          window.location.search = params.toString();
        });

        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        async function ensureMermaid() {
          if (window.mermaid && typeof window.mermaid.render === "function") {
            return;
          }
          try {
            await loadScript(localMermaidUrl);
          } catch (err) {
            // ignore and try CDN
          }
          if (window.mermaid && typeof window.mermaid.render === "function") {
            return;
          }
          await loadScript(
            "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"
          );
        }

        async function loadGraph() {
          statusEl.textContent = "Loading graph...";
          try {
            await ensureMermaid();
          } catch (err) {
            statusEl.textContent = "Mermaid not loaded";
            return;
          }
          const response = await fetch(graphUrl, { cache: "no-store" });
          if (!response.ok) {
            statusEl.textContent = "Failed to load graph.json";
            return;
          }
          const payload = await response.json();
          const mode = currentMode();
          const lines = ["graph TD"];
          if (mode === "dependencies" || !payload.modules) {
            const graph = payload.dependency_graph || payload.graph || {};
            const nodes = new Set();
            Object.keys(graph).forEach((key) => key && nodes.add(key));
            Object.values(graph).forEach((deps) => {
              (deps || []).forEach((dep) => dep && nodes.add(dep));
            });
            const ordered = Array.from(nodes).sort();
            const nodeIds = new Map();
            ordered.forEach((name, idx) => nodeIds.set(name, `n${idx}`));
            ordered.forEach((name) => {
              const id = nodeIds.get(name);
              const label = String(name).replace(/[^A-Za-z0-9_\\-]/g, "_");
              lines.push(`${id}[${label}]`);
            });
            for (const [name, deps] of Object.entries(graph)) {
              const sourceId = nodeIds.get(name);
              if (!sourceId) continue;
              (deps || []).forEach((dep) => {
                const targetId = nodeIds.get(dep);
                if (targetId) {
                  lines.push(`${sourceId} --> ${targetId}`);
                }
              });
            }
            statusEl.textContent = `${ordered.length} nodes`;
          } else {
            const moduleGraph = payload.modules;
            const nodes = moduleGraph.nodes || [];
            const edges = moduleGraph.edges || [];
            const idMap = new Map();
            lines.push("classDef module fill:#1e3a8a,stroke:#1e40af,color:#ffffff,rx:4,ry:4;");
            lines.push("classDef controller fill:#0f766e,stroke:#115e59,color:#ffffff,rx:4,ry:4;");
            lines.push("classDef provider fill:#0ea5e9,stroke:#0369a1,color:#ffffff,rx:4,ry:4;");
            nodes.forEach((node, idx) => idMap.set(node.id, `m${idx}`));
            nodes.forEach((node, idx) => {
              const id = idMap.get(node.id) || `m${idx}`;
              const label = String(node.label).replace(/[^A-Za-z0-9_\\-]/g, "_");
              lines.push(`${id}[${label}]`);
              if (node.type === "module") {
                lines.push(`class ${id} module`);
              } else if (node.type === "controller") {
                lines.push(`class ${id} controller`);
              } else {
                lines.push(`class ${id} provider`);
              }
            });
            edges.forEach((edge) => {
              const sourceId = idMap.get(edge.source);
              const targetId = idMap.get(edge.target);
              if (sourceId && targetId) {
                lines.push(`${sourceId} --> ${targetId}`);
              }
            });
            statusEl.textContent = `${nodes.length} nodes`;
          }
          const definition = lines.join("\n").replace(/\\n/g, "\n");
          graphEl.removeAttribute("data-processed");
          graphEl.innerHTML = definition;
          mermaid.initialize({
            startOnLoad: false,
            theme: "dark",
            flowchart: {
              nodeSpacing: 110,
              rankSpacing: 500,
            },
          });
          try {
            if (typeof mermaid.render === "function") {
              graphEl.innerHTML = "";
              const result = await mermaid.render(
                `graph-${Date.now()}`,
                definition
              );
              graphEl.innerHTML = result.svg;
              if (result.bindFunctions) {
                result.bindFunctions(graphEl);
              }
            } else if (typeof mermaid.run === "function") {
              const nodes = document.querySelectorAll(".mermaid");
              const result = mermaid.run({ nodes });
              if (result && typeof result.then === "function") {
                await result;
              }
            } else if (typeof mermaid.init === "function") {
              mermaid.init(undefined, document.querySelectorAll(".mermaid"));
            }
          } catch (err) {
            statusEl.textContent =
              err && err.message ? `Mermaid render failed: ${err.message}` : "Mermaid render failed";
          }
        }

        loadGraph().catch(() => {
          statusEl.textContent = "Graph render failed";
        });
      })();
    </script>
  </body>
</html>
